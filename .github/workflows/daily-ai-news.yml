name: Daily AI News Collector

on:
  schedule:
    - cron: '0 4 * * *'  # é˜¿è¯é…‹æ—©ä¸Š8é»
  workflow_dispatch:

jobs:
  collect-and-send:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # ğŸ‘ˆ å¢åŠ è¶…æ™‚æ™‚é–“
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # ğŸ‘‡ æ”¹é€²çš„å¿«å–æ©Ÿåˆ¶
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # ğŸ‘‡ æ›´å®‰å…¨çš„artifactä¸‹è¼‰
    - name: Check for previous data
      id: check-artifact
      run: |
        echo "æª¢æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„è³‡æ–™..."
        echo "first-run=true" >> $GITHUB_OUTPUT
    
    - name: Download previous data (if exists)
      uses: actions/download-artifact@v4
      with:
        name: ai-news-data
        path: .
      continue-on-error: true
    
    - name: Create empty data file if needed
      run: |
        if [ ! -f ai_news_data.csv ]; then
          echo "å»ºç«‹ç©ºçš„è³‡æ–™æª”æ¡ˆ..."
          echo "hash_id,title,url,summary,content,published_date,source,category,relevance_score,sentiment_score,ai_summary,collected_date" > ai_news_data.csv
        else
          echo "æ‰¾åˆ°ç¾æœ‰è³‡æ–™æª”æ¡ˆï¼Œè¡Œæ•¸: $(wc -l < ai_news_data.csv)"
        fi
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # ğŸ‘‡ åŠ ä¸Šè¶…æ™‚ä¿è­·çš„ä¸»ç¨‹å¼åŸ·è¡Œ
    - name: Run AI news collector with timeout protection
      timeout-minutes: 35  # çµ¦ä¸»ç¨‹å¼35åˆ†é˜
      env:
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        echo "é–‹å§‹åŸ·è¡ŒAIæ–°èæ”¶é›†..."
        python ai_news_collector.py || echo "ç¨‹å¼åŸ·è¡Œå®Œæˆï¼ˆå¯èƒ½æœ‰éŒ¯èª¤ä½†ç¹¼çºŒï¼‰"
    
    # ğŸ‘‡ é¡¯ç¤ºåŸ·è¡Œçµæœ
    - name: Show execution results
      if: always()
      run: |
        echo "=== åŸ·è¡Œçµæœæ‘˜è¦ ==="
        if [ -f ai_news_data.csv ]; then
          echo "è³‡æ–™æª”æ¡ˆå¤§å°: $(wc -l < ai_news_data.csv) è¡Œ"
          echo "æœ€å¾Œ5è¡Œå…§å®¹:"
          tail -5 ai_news_data.csv
        fi
        if [ -f collector.log ]; then
          echo "æ—¥èªŒæª”æ¡ˆå¤§å°: $(wc -l < collector.log) è¡Œ"
          echo "æœ€å¾Œ10è¡Œæ—¥èªŒ:"
          tail -10 collector.log
        fi
        echo "ç£ç¢Ÿä½¿ç”¨æƒ…æ³:"
        du -sh .
    
    # ğŸ‘‡ ç¸½æ˜¯ä¸Šå‚³è³‡æ–™ï¼ˆå³ä½¿ç¨‹å¼å¤±æ•—ï¼‰
    - name: Upload updated data
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ai-news-data
        path: |
          ai_news_data.csv
          collector.log
        retention-days: 90
        overwrite: true
    
    # ğŸ‘‡ ç™¼é€å¤±æ•—é€šçŸ¥ï¼ˆå¯é¸ï¼‰
    - name: Report failure
      if: failure()
      run: |
        echo "ç¨‹å¼åŸ·è¡Œå¤±æ•—ï¼Œä½†å·²ä¿å­˜ç¾æœ‰è³‡æ–™"
        echo "è«‹æª¢æŸ¥æ—¥èªŒä»¥äº†è§£å¤±æ•—åŸå› "